name: "2. Sentinel Policy Check"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to check policies for'
        required: true
        type: string
  workflow_run:
    workflows: ["1. Terraform Plan"]
    types:
      - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  TF_MAX_TIMEOUT: "3600000" # 1 hour in milliseconds

jobs:
  policy-check:
    name: "Evaluate Sentinel Policies"
    runs-on: ubuntu-latest

    outputs:
      policies_enabled: ${{ steps.policy-checks.outputs.policies_enabled }}
      policies_passed: ${{ steps.policy-checks.outputs.policies_passed }}
      policies_failed: ${{ steps.policy-checks.outputs.policies_advisory_failed }}
      policies_mandatory_failed: ${{ steps.policy-checks.outputs.policies_mandatory_failed }}
      requires_override: ${{ steps.policy-override.outputs.requires_override }}
      override_detected: ${{ steps.wait-for-override.outputs.override_detected }}
      override_comment: ${{ steps.wait-for-override.outputs.override_comment }}
      run_discarded: ${{ steps.wait-for-override.outputs.run_discarded }}
      run_canceled: ${{ steps.wait-for-override.outputs.run_canceled }}
      manual_apply_completed: ${{ steps.wait-for-override.outputs.manual_apply_completed }}
      run_id: ${{ steps.determine-run.outputs.run_id }}
      run_link: ${{ steps.determine-run.outputs.run_link }}

    steps:
      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "ðŸ“ Using manually provided run ID: $RUN_ID"
          else
            # Get the run ID from the Plan workflow
            # This would need to be passed via artifact or API call
            echo "::error::No run ID provided. Please provide run_id input."
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/$RUN_ID" >> $GITHUB_OUTPUT

      - name: Get Policy Checks
        id: policy-checks
        run: |
          # Function: Call TFC API with consistent auth headers
          tfc_api_call() {
            local endpoint=$1
            curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2${endpoint}"
          }

          RUN_ID="${{ steps.determine-run.outputs.run_id }}"

          echo "ðŸ” Retrieving policy evaluation results..."
          echo ""

          # Get run details
          RUN_DATA=$(tfc_api_call "/runs/$RUN_ID")

          # Get task stages for this run (includes policy evaluations)
          TASK_STAGES=$(tfc_api_call "/runs/$RUN_ID/task-stages")

          # Check if any policy evaluations exist
          POLICY_STAGE_ID=$(echo "$TASK_STAGES" | jq -r '.data[] | select(.attributes.stage == "post_plan") | .id' | head -n1)

          if [[ -z "$POLICY_STAGE_ID" || "$POLICY_STAGE_ID" == "null" ]]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace"
            exit 0
          fi

          echo "policies_enabled=true" >> $GITHUB_OUTPUT

          # Get policy evaluations for this stage
          POLICY_EVALS=$(tfc_api_call "/task-stages/$POLICY_STAGE_ID/policy-evaluations")

          # Get the policy evaluation ID for detailed results
          POLICY_EVAL_ID=$(echo "$POLICY_EVALS" | jq -r '.data[0].id')

          # Count policy results using the correct attribute structure
          TOTAL=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count" | .passed + ."advisory-failed" + ."mandatory-failed" + .errored] | add // 0')
          PASSED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count".passed] | add // 0')
          ADVISORY_FAILED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count"."advisory-failed"] | add // 0')
          MANDATORY_FAILED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count"."mandatory-failed"] | add // 0')
          ERRORED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count".errored] | add // 0')

          # Store detailed policy results for later display
          echo "policy_eval_id=$POLICY_EVAL_ID" >> $GITHUB_OUTPUT
          echo "policy_stage_id=$POLICY_STAGE_ID" >> $GITHUB_OUTPUT
          echo "policy_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "policies_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "policies_advisory_failed=$ADVISORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_errored=$ERRORED" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Policy Evaluation Summary:"
          echo "   Total Policies: $TOTAL"
          echo "   âœ… Passed: $PASSED"
          echo "   âš ï¸  Failed (Advisory): $ADVISORY_FAILED"
          echo "   ðŸš« Failed (Mandatory): $MANDATORY_FAILED"
          echo "   âŒ Errored: $ERRORED"
          echo ""

          # Fetch individual policy results
          if [[ -n "$POLICY_EVAL_ID" && "$POLICY_EVAL_ID" != "null" && "$MANDATORY_FAILED" -gt 0 ]]; then
            echo "ðŸ” Fetching individual policy results..."

            # Get policy set results
            POLICY_SET_RESULTS=$(tfc_api_call "/policy-evaluations/$POLICY_EVAL_ID/policy-set-outcomes")

            # Extract failed mandatory policies with safer parsing
            FAILED_MANDATORY_POLICIES=$(echo "$POLICY_SET_RESULTS" | jq -r '
              if .included then
                [.included[] |
                  select(.type == "policy-outcomes") |
                  select(.attributes."enforcement-level" == "mandatory" and .attributes.status == "failed") |
                  "- **\(.attributes."policy-name")** (mandatory)"
                ] |
                if length > 0 then
                  join("\n")
                else
                  "No specific policy details available - view in TFC"
                end
              else
                "No specific policy details available - view in TFC"
              end
            ')

            # Save failed policies to output
            {
              echo "failed_mandatory_policies<<EOF"
              echo "$FAILED_MANDATORY_POLICIES"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            echo ""
            echo "ðŸš« Failed Mandatory Policies:"
            echo "$FAILED_MANDATORY_POLICIES"
            echo ""
          else
            # No policy details to fetch
            {
              echo "failed_mandatory_policies<<EOF"
              echo "View detailed policy failures in TFC"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

          # Save placeholder for summary (TFC link will be provided)
          echo "policy_details=View detailed policy results in TFC" >> $GITHUB_OUTPUT

      - name: Check if Override Required
        id: policy-override
        run: |
          if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ]; then
            echo "requires_override=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸  MANDATORY POLICIES FAILED - OVERRIDE REQUIRED"
            echo ""
            echo "Failed Policies:"
            echo "${{ steps.policy-checks.outputs.failed_mandatory_policies }}"
            echo ""
            echo "Next Steps:"
            echo "  1. Review the failed policies above"
            echo "  2. Review detailed policy output in TFC: ${{ steps.determine-run.outputs.run_link }}"
            echo "  3. If override is justified, run the '2a. Policy Override' workflow"
            echo "  4. Otherwise, fix the code and create a new plan"
            echo ""
          else
            echo "requires_override=false" >> $GITHUB_OUTPUT
            echo "âœ… All policies passed or only advisory failures"
            echo "Proceed to Apply workflow (Workflow 3)"
          fi

      - name: Stop if Override Required
        if: steps.policy-override.outputs.requires_override == 'true'
        run: |
          echo "::error::â›” Mandatory policy failures detected"
          echo "::error::"
          echo "::error::This workflow stops here to allow review of failed policies."
          echo "::error::"
          echo "::error::Next steps:"
          echo "::error::  1. Review failed policies in the summary below"
          echo "::error::  2. Review detailed output in TFC: ${{ steps.determine-run.outputs.run_link }}"
          echo "::error::  3. Run '2a. Policy Override' workflow to override if justified"
          echo "::error::  4. OR fix the code and create a new plan (Workflow 1)"
          exit 1

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Sentinel Policy Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Policy Check Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 2. Sentinel Policy Check |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ steps.determine-run.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Policy evaluation results
          if [ "${{ steps.policy-checks.outputs.policies_enabled }}" == "true" ]; then
            echo "### ðŸ›¡ï¸ Sentinel Policy Evaluations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Result Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Passed** | ${{ steps.policy-checks.outputs.policies_passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ **Failed (Advisory)** | ${{ steps.policy-checks.outputs.policies_advisory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš« **Failed (Mandatory)** | ${{ steps.policy-checks.outputs.policies_mandatory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ **Errored** | ${{ steps.policy-checks.outputs.policies_errored }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ **Total Evaluations** | ${{ steps.policy-checks.outputs.policy_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show failed mandatory policies
            if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ðŸš« Failed Mandatory Policies" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.policy-checks.outputs.failed_mandatory_policies }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> âš ï¸ **Override Required**: These mandatory policies are blocking deployment." >> $GITHUB_STEP_SUMMARY
              echo "> - View [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
              echo "> - Run the **2a. Policy Override** workflow if override is justified" >> $GITHUB_STEP_SUMMARY
              echo "> - OR fix the code and create a new plan" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.policy-checks.outputs.policies_advisory_failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### âš ï¸ Advisory Policy Warnings" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Advisory Failures**: ${{ steps.policy-checks.outputs.policies_advisory_failed }} (warnings only, does not block deployment)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> View [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> âœ… **All Policies Passed**: No overrides required." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Policies Configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Sentinel policies are configured for this workspace." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Next steps
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.policy-override.outputs.requires_override }}" == "true" ]; then
            echo "**Mandatory Policy Override Required:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the failed mandatory policies listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Review [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
            echo "3. **Option A**: Run \`2a. Policy Override\` workflow to override (provide justification)" >> $GITHUB_STEP_SUMMARY
            echo "4. **Option B**: Fix the infrastructure code and run \`1. Terraform Plan\` again" >> $GITHUB_STEP_SUMMARY
            echo "5. **Option C**: Discard the run in TFC if deployment should not proceed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Policies Passed - Ready to Apply:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Run the \`3. Terraform Apply\` workflow to apply infrastructure changes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Sentinel Policy Check*" >> $GITHUB_STEP_SUMMARY
