name: "2. Sentinel Policy Check"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "TFC Run ID to check policies for"
        required: true
        type: string
  workflow_run:
    workflows: ["1. Terraform Plan"]
    types:
      - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}

jobs:
  policy-check:
    name: "Check Sentinel Policies"
    runs-on: ubuntu-latest

    steps:
      - name: Download Run ID Artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: terraform-run-data
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
          elif [ -f "run_id.txt" ]; then
            RUN_ID=$(cat run_id.txt)
          else
            echo "::error::No run ID provided"
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Check Policies
        id: policy-check
        run: |
          docker run --rm \
            -e TF_API_TOKEN="${{ env.TF_API_TOKEN }}" \
            cloudbrokeraz/tfci:latest \
            tfci -organization "${{ env.TF_CLOUD_ORGANIZATION }}" \
            policy show --run "${{ steps.determine-run.outputs.run_id }}" --json > policy.json

          # Extract key details
          TOTAL=$(jq -r '.total_count // 0' policy.json)
          PASSED=$(jq -r '.passed_count // 0' policy.json)
          ADVISORY_FAILED=$(jq -r '.advisory_failed_count // 0' policy.json)
          MANDATORY_FAILED=$(jq -r '.mandatory_failed_count // 0' policy.json)
          ERRORED=$(jq -r '.errored_count // 0' policy.json)

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "advisory_failed=$ADVISORY_FAILED" >> $GITHUB_OUTPUT
          echo "mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT
          echo "errored=$ERRORED" >> $GITHUB_OUTPUT
          echo "requires_override=$([ "$MANDATORY_FAILED" -gt 0 ] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Extract pre-formatted markdown (already formatted by tfci)
          FAILED_POLICIES_MD=$(jq -r '.failed_policies_markdown // ""' policy.json)

          {
            echo "failed_policies<<EOF"
            echo "$FAILED_POLICIES_MD"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          cat policy.json
          rm -f policy.json

      - name: Generate Summary
        if: always()
        run: |
          RUN_LINK="https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/${{ steps.determine-run.outputs.run_id }}"

          echo "# ðŸ›¡ï¸ Sentinel Policy Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.policy-check.outputs.total }}" -eq 0 ]; then
            echo "No policies configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | ${{ steps.policy-check.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Advisory | ${{ steps.policy-check.outputs.advisory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš« Mandatory | ${{ steps.policy-check.outputs.mandatory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Errored | ${{ steps.policy-check.outputs.errored }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Display failed policies if any
            if [ -n "${{ steps.policy-check.outputs.failed_policies }}" ]; then
              echo "**Failed Policies:**" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.policy-check.outputs.failed_policies }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ steps.policy-check.outputs.requires_override }}" == "true" ]; then
              echo "âš ï¸ Override required - Run **2a. Policy Override**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… Ready - Run **3. Terraform Apply**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Run]($RUN_LINK)" >> $GITHUB_STEP_SUMMARY
