name: "2. Sentinel Policy Check"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to check policies for'
        required: true
        type: string
  workflow_run:
    workflows: ["1. Terraform Plan"]
    types:
      - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  TF_MAX_TIMEOUT: "3600000" # 1 hour in milliseconds

jobs:
  policy-check:
    name: "Evaluate Sentinel Policies"
    runs-on: ubuntu-latest

    outputs:
      policies_enabled: ${{ steps.policy-checks.outputs.policies_enabled }}
      policies_passed: ${{ steps.policy-checks.outputs.policies_passed }}
      policies_failed: ${{ steps.policy-checks.outputs.policies_advisory_failed }}
      policies_mandatory_failed: ${{ steps.policy-checks.outputs.policies_mandatory_failed }}
      requires_override: ${{ steps.policy-override.outputs.requires_override }}
      override_detected: ${{ steps.wait-for-override.outputs.override_detected }}
      override_comment: ${{ steps.wait-for-override.outputs.override_comment }}
      run_discarded: ${{ steps.wait-for-override.outputs.run_discarded }}
      run_canceled: ${{ steps.wait-for-override.outputs.run_canceled }}
      manual_apply_completed: ${{ steps.wait-for-override.outputs.manual_apply_completed }}
      run_id: ${{ steps.determine-run.outputs.run_id }}
      run_link: ${{ steps.determine-run.outputs.run_link }}

    steps:
      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "ðŸ“ Using manually provided run ID: $RUN_ID"
          else
            # Get the run ID from the Plan workflow
            # This would need to be passed via artifact or API call
            echo "::error::No run ID provided. Please provide run_id input."
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/$RUN_ID" >> $GITHUB_OUTPUT

      - name: Get Policy Checks
        id: policy-checks
        run: |
          # Function: Call TFC API with consistent auth headers
          tfc_api_call() {
            local endpoint=$1
            curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2${endpoint}"
          }

          RUN_ID="${{ steps.determine-run.outputs.run_id }}"

          echo "ðŸ” Retrieving policy evaluation results..."
          echo ""

          # Get run details
          RUN_DATA=$(tfc_api_call "/runs/$RUN_ID")

          # Get task stages for this run (includes policy evaluations)
          TASK_STAGES=$(tfc_api_call "/runs/$RUN_ID/task-stages")

          # Check if any policy evaluations exist
          POLICY_STAGE_ID=$(echo "$TASK_STAGES" | jq -r '.data[] | select(.attributes.stage == "post_plan") | .id' | head -n1)

          if [[ -z "$POLICY_STAGE_ID" || "$POLICY_STAGE_ID" == "null" ]]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace"
            exit 0
          fi

          echo "policies_enabled=true" >> $GITHUB_OUTPUT

          # Get policy evaluations for this stage
          POLICY_EVALS=$(tfc_api_call "/task-stages/$POLICY_STAGE_ID/policy-evaluations")

          # Get the policy evaluation ID for detailed results
          POLICY_EVAL_ID=$(echo "$POLICY_EVALS" | jq -r '.data[0].id')

          # Count policy results using the correct attribute structure
          TOTAL=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count" | .passed + ."advisory-failed" + ."mandatory-failed" + .errored] | add // 0')
          PASSED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count".passed] | add // 0')
          ADVISORY_FAILED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count"."advisory-failed"] | add // 0')
          MANDATORY_FAILED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count"."mandatory-failed"] | add // 0')
          ERRORED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count".errored] | add // 0')

          # Store detailed policy results for later display
          echo "policy_eval_id=$POLICY_EVAL_ID" >> $GITHUB_OUTPUT
          echo "policy_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "policies_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "policies_advisory_failed=$ADVISORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_errored=$ERRORED" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Policy Evaluation Summary:"
          echo "   Total Policies: $TOTAL"
          echo "   âœ… Passed: $PASSED"
          echo "   âš ï¸  Failed (Advisory): $ADVISORY_FAILED"
          echo "   ðŸš« Failed (Mandatory): $MANDATORY_FAILED"
          echo "   âŒ Errored: $ERRORED"
          echo ""

          # Note: Individual policy details are available in TFC UI
          # The API provides aggregate counts but individual policy names/results
          # require fetching the full policy output which is large
          echo ""
          echo "â„¹ï¸  For detailed policy results (individual policy names and outputs):"
          echo "   View the full report in TFC: ${{ steps.determine-run.outputs.run_link }}"
          echo ""

          # Save placeholder for summary (TFC link will be provided)
          echo "policy_details=View detailed policy results in TFC" >> $GITHUB_OUTPUT

      - name: Check if Override Required
        id: policy-override
        run: |
          if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ]; then
            echo "requires_override=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Mandatory policies failed - override required to proceed"
          else
            echo "requires_override=false" >> $GITHUB_OUTPUT
            echo "âœ… All policies passed or only advisory failures"
          fi

      - name: Check Workspace Configuration
        if: steps.policy-override.outputs.requires_override == 'true'
        run: |
          WORKSPACE_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/organizations/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}")

          AUTO_APPLY=$(echo "$WORKSPACE_DATA" | jq -r '.data.attributes."auto-apply"')

          if [[ "$AUTO_APPLY" == "true" ]]; then
            echo "::notice::âš¡ Workspace has auto-apply enabled"
            echo "After policy override, TFC will automatically queue the apply."
          else
            echo "::notice::âœ‹ Workspace has manual apply (auto-apply: false)"
            echo "After policy override, run the Apply workflow to complete deployment."
          fi

      - name: Wait for Policy Override
        id: wait-for-override
        if: steps.policy-override.outputs.requires_override == 'true'
        timeout-minutes: 60
        run: |
          # Function: Call TFC API with consistent auth headers
          tfc_api_call() {
            local endpoint=$1
            curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2${endpoint}"
          }

          # Function: Extract override details from comments
          extract_override_details() {
            local run_id=$1

            # Fetch override comment from comments API
            local comments_data=$(tfc_api_call "/runs/$run_id/comments")
            local override_comment=$(echo "$comments_data" | jq -r '.data[-1].attributes.body // "No comment provided"')

            # Output to GitHub Actions output
            {
              echo "override_comment<<EOF"
              echo "$override_comment"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          }

          # Function: Classify run status into actionable categories
          classify_run_status() {
            local status=$1

            case $status in
              post_plan_awaiting_decision)
                echo "waiting_override"
                ;;
              policy_override|post_plan_completed)
                echo "override_complete"
                ;;
              apply_queued)
                echo "apply_queued"
                ;;
              applying)
                echo "applying"
                ;;
              applied)
                echo "applied"
                ;;
              discarded)
                echo "discarded"
                ;;
              canceled|force_canceled)
                echo "canceled"
                ;;
              errored)
                echo "errored"
                ;;
              *)
                echo "unknown"
                ;;
            esac
          }

          MAX_WAIT=3600  # 1 hour
          ELAPSED=0
          CHECK_INTERVAL=30

          echo "â³ Waiting for policy override in TFC..."
          echo "Run ID: ${{ steps.determine-run.outputs.run_id }}"
          echo "View in TFC: ${{ steps.determine-run.outputs.run_link }}"
          echo ""
          echo "Please override the policy in the TFC UI to proceed."
          echo "This workflow will wait up to 1 hour for the override."
          echo ""

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RUN_DATA=$(tfc_api_call "/runs/${{ steps.determine-run.outputs.run_id }}")
            CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
            STATUS_CLASS=$(classify_run_status "$CURRENT_STATUS")

            echo "[$(date +%H:%M:%S)] Current run status: $CURRENT_STATUS (classified as: $STATUS_CLASS)"

            # Handle different status classifications
            case $STATUS_CLASS in
              override_complete|apply_queued)
                # Override detected - ready for apply
                echo ""
                echo "âœ… Policy override detected! Run status: $CURRENT_STATUS"
                echo "Override complete - ready for apply workflow..."

                # Extract override details
                extract_override_details "${{ steps.determine-run.outputs.run_id }}"

                # Mark as ready for apply
                echo "override_detected=true" >> $GITHUB_OUTPUT
                echo "manual_apply_completed=false" >> $GITHUB_OUTPUT
                exit 0
                ;;

              applying|applied)
                # Manual apply detected
                echo ""
                echo "âš ï¸  Apply was manually triggered in TFC UI (status: $CURRENT_STATUS)"
                echo "For proper workflow control, use the Apply workflow after override."

                # Extract override details
                extract_override_details "${{ steps.determine-run.outputs.run_id }}"

                # Mark as manually applied
                echo "override_detected=true" >> $GITHUB_OUTPUT
                echo "manual_apply_completed=true" >> $GITHUB_OUTPUT
                exit 0
                ;;

              discarded)
                # Run was discarded
                echo ""
                echo "ðŸ—‘ï¸  Run was discarded - user chose not to proceed"
                echo "No infrastructure changes have been applied."
                echo ""

                # Mark as discarded
                echo "run_discarded=true" >> $GITHUB_OUTPUT
                exit 0
                ;;

              canceled)
                # Run was canceled
                echo ""
                echo "â›” Run was canceled manually in TFC"
                echo "Infrastructure changes will not be applied."
                echo ""

                # Mark as canceled
                echo "run_canceled=true" >> $GITHUB_OUTPUT
                exit 1
                ;;

              errored)
                echo "::error::âŒ Run entered error state: $CURRENT_STATUS"
                exit 1
                ;;

              waiting_override)
                # Still waiting - continue polling
                ;;

              *)
                echo "::warning::âš ï¸  Unexpected status: $CURRENT_STATUS"
                ;;
            esac

            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done

          # Timeout reached
          echo "::error::â±ï¸  Timeout: No policy override detected after 1 hour"
          echo "::error::Run is still waiting for override at: ${{ steps.determine-run.outputs.run_link }}"
          exit 1

      - name: Run Discarded
        if: always() && steps.wait-for-override.outputs.run_discarded == 'true'
        run: |
          echo "::notice::ðŸ—‘ï¸  Run was discarded by user"
          echo "This is not an error - the run was intentionally discarded."
          echo "No further action needed."

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Sentinel Policy Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Policy Check Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 2. Sentinel Policy Check |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ steps.determine-run.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Policy evaluation results
          if [ "${{ steps.policy-checks.outputs.policies_enabled }}" == "true" ]; then
            echo "### ðŸ›¡ï¸ Sentinel Policy Evaluations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Result Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Passed** | ${{ steps.policy-checks.outputs.policies_passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ **Failed (Advisory)** | ${{ steps.policy-checks.outputs.policies_advisory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš« **Failed (Mandatory)** | ${{ steps.policy-checks.outputs.policies_mandatory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ **Errored** | ${{ steps.policy-checks.outputs.policies_errored }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ **Total Evaluations** | ${{ steps.policy-checks.outputs.policy_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Link to detailed policy results
            if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ] || [ "${{ steps.policy-checks.outputs.policies_advisory_failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ðŸ“‹ Policy Failure Details" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Failed Policies:**" >> $GITHUB_STEP_SUMMARY
              echo "- **Mandatory Failures**: ${{ steps.policy-checks.outputs.policies_mandatory_failed }} (blocks deployment)" >> $GITHUB_STEP_SUMMARY
              echo "- **Advisory Failures**: ${{ steps.policy-checks.outputs.policies_advisory_failed }} (warnings only)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> ðŸ’¡ **Action Required**: View the [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }}) to see:" >> $GITHUB_STEP_SUMMARY
              echo "> - Which specific policies failed" >> $GITHUB_STEP_SUMMARY
              echo "> - Policy failure reasons and context" >> $GITHUB_STEP_SUMMARY
              echo "> - Sentinel policy evaluation logs" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> Based on the failures, decide whether to:" >> $GITHUB_STEP_SUMMARY
              echo "> - **Override** the mandatory policies (if exception is justified)" >> $GITHUB_STEP_SUMMARY
              echo "> - **Fix** the infrastructure code to comply" >> $GITHUB_STEP_SUMMARY
              echo "> - **Discard** the run if changes shouldn't be deployed" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # Override details
            if [ "${{ steps.wait-for-override.outputs.override_detected }}" == "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ðŸ›¡ï¸ Policy Override Details" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Justification:**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> ${{ steps.wait-for-override.outputs.override_comment }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> ðŸ“ **Audit Trail**: Policy override decision recorded. All overrides are logged in Terraform Cloud for compliance review." >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.wait-for-override.outputs.run_discarded }}" == "true" ]; then
              echo "> ðŸ—‘ï¸ **Run Discarded**: User chose not to proceed with this deployment." >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.policy-override.outputs.requires_override }}" == "true" ]; then
              echo "> âš ï¸ **Action Required**: ${{ steps.policy-checks.outputs.policies_mandatory_failed }} mandatory policies failed. Override required in [TFC UI](${{ steps.determine-run.outputs.run_link }})." >> $GITHUB_STEP_SUMMARY
            else
              echo "> âœ… **All Policies Passed**: No overrides required." >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Policies Configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Sentinel policies are configured for this workspace." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Next steps
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          RUN_DISCARDED="${{ steps.wait-for-override.outputs.run_discarded }}"
          RUN_CANCELED="${{ steps.wait-for-override.outputs.run_canceled }}"
          MANUAL_APPLY="${{ steps.wait-for-override.outputs.manual_apply_completed }}"
          OVERRIDE_DETECTED="${{ steps.wait-for-override.outputs.override_detected }}"

          if [[ "$RUN_DISCARDED" == "true" ]]; then
            echo "- **Workflow Complete**: Run was discarded, no further action needed" >> $GITHUB_STEP_SUMMARY
          elif [[ "$RUN_CANCELED" == "true" ]]; then
            echo "- **Workflow Canceled**: Run was canceled in TFC" >> $GITHUB_STEP_SUMMARY
          elif [[ "$MANUAL_APPLY" == "true" ]]; then
            echo "- **Already Applied**: Changes were applied manually in TFC UI" >> $GITHUB_STEP_SUMMARY
          elif [[ "$OVERRIDE_DETECTED" == "true" ]]; then
            echo "- **Ready for Apply**: Run the \`3-terraform-apply\` workflow to apply changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Waiting**: Override policy in TFC or run will timeout" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Sentinel Policy Check*" >> $GITHUB_STEP_SUMMARY
