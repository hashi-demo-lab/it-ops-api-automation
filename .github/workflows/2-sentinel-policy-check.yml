name: "2. Sentinel Policy Check"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to check policies for'
        required: true
        type: string
  workflow_run:
    workflows: ["1. Terraform Plan"]
    types:
      - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  TF_MAX_TIMEOUT: "3600000" # 1 hour in milliseconds

jobs:
  policy-check:
    name: "Evaluate Sentinel Policies"
    runs-on: ubuntu-latest

    outputs:
      policies_enabled: ${{ steps.policy-checks.outputs.policies_enabled }}
      policies_passed: ${{ steps.policy-checks.outputs.policies_passed }}
      policies_failed: ${{ steps.policy-checks.outputs.policies_advisory_failed }}
      policies_mandatory_failed: ${{ steps.policy-checks.outputs.policies_mandatory_failed }}
      requires_override: ${{ steps.policy-override.outputs.requires_override }}
      override_detected: ${{ steps.wait-for-override.outputs.override_detected }}
      override_comment: ${{ steps.wait-for-override.outputs.override_comment }}
      run_discarded: ${{ steps.wait-for-override.outputs.run_discarded }}
      run_canceled: ${{ steps.wait-for-override.outputs.run_canceled }}
      manual_apply_completed: ${{ steps.wait-for-override.outputs.manual_apply_completed }}
      run_id: ${{ steps.determine-run.outputs.run_id }}
      run_link: ${{ steps.determine-run.outputs.run_link }}

    steps:
      - name: Download Run ID Artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: terraform-run-data
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "ðŸ“ Using manually provided run ID: $RUN_ID"
          elif [ -f "run_id.txt" ]; then
            RUN_ID=$(cat run_id.txt)
            echo "ðŸ“ Using run ID from Plan workflow: $RUN_ID"
          else
            echo "::error::No run ID provided. Please provide run_id input or trigger from Plan workflow."
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/$RUN_ID" >> $GITHUB_OUTPUT

      - name: Get Policy Checks
        id: policy-checks
        run: |
          RUN_ID="${{ steps.determine-run.outputs.run_id }}"

          echo "ðŸ” Retrieving policy evaluation results using tfci..."
          echo ""

          # Use tfci Docker image to get policy evaluation
          docker run --rm \
            -e TF_API_TOKEN="${{ secrets.TF_API_TOKEN }}" \
            cloudbrokeraz/tfci:latest \
            tfci -organization "${{ env.TF_CLOUD_ORGANIZATION }}" \
            policy show --run "$RUN_ID" --json > policy_output.json

          # Check if tfci command succeeded
          if [ $? -ne 0 ]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace or error retrieving policies"
            exit 0
          fi

          # Parse JSON output from tfci
          TOTAL=$(jq -r '.total_count // 0' policy_output.json)
          PASSED=$(jq -r '.passed_count // 0' policy_output.json)
          ADVISORY_FAILED=$(jq -r '.advisory_failed_count // 0' policy_output.json)
          MANDATORY_FAILED=$(jq -r '.mandatory_failed_count // 0' policy_output.json)
          ERRORED=$(jq -r '.errored_count // 0' policy_output.json)
          REQUIRES_OVERRIDE=$(jq -r '.requires_override // false' policy_output.json)
          POLICY_STATUS=$(jq -r '.policy_status // "unknown"' policy_output.json)

          if [ "$TOTAL" -eq 0 ]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace"
            exit 0
          fi

          echo "policies_enabled=true" >> $GITHUB_OUTPUT

          # Store policy results
          echo "policy_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "policies_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "policies_advisory_failed=$ADVISORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_errored=$ERRORED" >> $GITHUB_OUTPUT
          echo "policy_status=$POLICY_STATUS" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Policy Evaluation Summary:"
          echo "   Total Policies: $TOTAL"
          echo "   âœ… Passed: $PASSED"
          echo "   âš ï¸  Failed (Advisory): $ADVISORY_FAILED"
          echo "   ðŸš« Failed (Mandatory): $MANDATORY_FAILED"
          echo "   âŒ Errored: $ERRORED"
          echo ""

          # Extract failed policies summary from description
          # Note: The description contains the actual count of failed policies
          # The policy_name field is a generated ID, not the actual policy name
          FAILED_MANDATORY_POLICIES=$(jq -r '
            .failed_policies // "[]" | fromjson |
            if length > 0 then
              map("- \(.description)") | join("\n")
            else
              "View detailed policy failures in TFC"
            end
          ' policy_output.json)

          # Save failed policies to output
          {
            echo "failed_mandatory_policies<<EOF"
            echo "$FAILED_MANDATORY_POLICIES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

          if [ "$MANDATORY_FAILED" -gt 0 ]; then
            echo ""
            echo "ðŸš« Failed Mandatory Policies:"
            echo "$FAILED_MANDATORY_POLICIES"
            echo ""
          fi

          # Clean up
          rm -f policy_output.json

      - name: Check if Override Required
        id: policy-override
        run: |
          if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ]; then
            echo "requires_override=true" >> $GITHUB_OUTPUT
            echo ""
            echo "âš ï¸  MANDATORY POLICIES FAILED - OVERRIDE REQUIRED"
            echo ""
            echo "Failed Policies:"
            echo "${{ steps.policy-checks.outputs.failed_mandatory_policies }}"
            echo ""
            echo "Next Steps:"
            echo "  1. Review the failed policies above"
            echo "  2. Review detailed policy output in TFC: ${{ steps.determine-run.outputs.run_link }}"
            echo "  3. If override is justified, run the '2a. Policy Override' workflow"
            echo "  4. Otherwise, fix the code and create a new plan"
            echo ""
          else
            echo "requires_override=false" >> $GITHUB_OUTPUT
            echo "âœ… All policies passed or only advisory failures"
            echo "Proceed to Apply workflow (Workflow 3)"
          fi

      - name: Policy Review Complete
        if: steps.policy-override.outputs.requires_override == 'true'
        run: |
          echo "::warning::âš ï¸  Mandatory policy failures detected"
          echo "::warning::"
          echo "::warning::Review the failed policies in the summary below."
          echo "::warning::"
          echo "::warning::Next steps:"
          echo "::warning::  1. Review failed policies in the summary"
          echo "::warning::  2. Review detailed output in TFC: ${{ steps.determine-run.outputs.run_link }}"
          echo "::warning::  3. Run '2a. Policy Override' workflow to override if justified"
          echo "::warning::  4. OR fix the code and create a new plan (Workflow 1)"

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Sentinel Policy Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Policy Check Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 2. Sentinel Policy Check |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ steps.determine-run.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Policy evaluation results
          if [ "${{ steps.policy-checks.outputs.policies_enabled }}" == "true" ]; then
            echo "### ðŸ›¡ï¸ Sentinel Policy Evaluations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Result Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Passed** | ${{ steps.policy-checks.outputs.policies_passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ **Failed (Advisory)** | ${{ steps.policy-checks.outputs.policies_advisory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš« **Failed (Mandatory)** | ${{ steps.policy-checks.outputs.policies_mandatory_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ **Errored** | ${{ steps.policy-checks.outputs.policies_errored }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ **Total Evaluations** | ${{ steps.policy-checks.outputs.policy_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show failed mandatory policies
            if [ "${{ steps.policy-checks.outputs.policies_mandatory_failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### ðŸš« Failed Mandatory Policies" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.policy-checks.outputs.failed_mandatory_policies }}" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> âš ï¸ **Override Required**: These mandatory policies are blocking deployment." >> $GITHUB_STEP_SUMMARY
              echo "> - View [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
              echo "> - Run the **2a. Policy Override** workflow if override is justified" >> $GITHUB_STEP_SUMMARY
              echo "> - OR fix the code and create a new plan" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.policy-checks.outputs.policies_advisory_failed }}" != "0" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "#### âš ï¸ Advisory Policy Warnings" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Advisory Failures**: ${{ steps.policy-checks.outputs.policies_advisory_failed }} (warnings only, does not block deployment)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> View [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> âœ… **All Policies Passed**: No overrides required." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### â„¹ï¸ No Policies Configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No Sentinel policies are configured for this workspace." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Next steps
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.policy-override.outputs.requires_override }}" == "true" ]; then
            echo "**Mandatory Policy Override Required:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the failed mandatory policies listed above" >> $GITHUB_STEP_SUMMARY
            echo "2. Review [detailed policy output in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
            echo "3. **Option A**: Run \`2a. Policy Override\` workflow to override (provide justification)" >> $GITHUB_STEP_SUMMARY
            echo "4. **Option B**: Fix the infrastructure code and run \`1. Terraform Plan\` again" >> $GITHUB_STEP_SUMMARY
            echo "5. **Option C**: Discard the run in TFC if deployment should not proceed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Policies Passed - Ready to Apply:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Run the \`3. Terraform Apply\` workflow to apply infrastructure changes" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Sentinel Policy Check*" >> $GITHUB_STEP_SUMMARY
