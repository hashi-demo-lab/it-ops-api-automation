name: "2. Sentinel Policy Check"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "TFC Run ID to check policies for"
        required: true
        type: string
  workflow_run:
    workflows: ["1. Terraform Plan"]
    types:
      - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}
  TF_MAX_TIMEOUT: "3600000" # 1 hour in milliseconds

jobs:
  policy-check:
    name: "Evaluate Sentinel Policies"
    runs-on: ubuntu-latest

    outputs:
      policies_enabled: ${{ steps.policy-checks.outputs.policies_enabled }}
      policies_passed: ${{ steps.policy-checks.outputs.policies_passed }}
      policies_failed: ${{ steps.policy-checks.outputs.policies_advisory_failed }}
      policies_mandatory_failed: ${{ steps.policy-checks.outputs.policies_mandatory_failed }}
      requires_override: ${{ steps.policy-override.outputs.requires_override }}
      override_detected: ${{ steps.wait-for-override.outputs.override_detected }}
      override_comment: ${{ steps.wait-for-override.outputs.override_comment }}
      run_discarded: ${{ steps.wait-for-override.outputs.run_discarded }}
      run_canceled: ${{ steps.wait-for-override.outputs.run_canceled }}
      manual_apply_completed: ${{ steps.wait-for-override.outputs.manual_apply_completed }}
      run_id: ${{ steps.determine-run.outputs.run_id }}
      run_link: ${{ steps.determine-run.outputs.run_link }}

    steps:
      - name: Download Run ID Artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: terraform-run-data
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "ğŸ“ Using manually provided run ID: $RUN_ID"
          elif [ -f "run_id.txt" ]; then
            RUN_ID=$(cat run_id.txt)
            echo "ğŸ“ Using run ID from Plan workflow: $RUN_ID"
          else
            echo "::error::No run ID provided. Please provide run_id input or trigger from Plan workflow."
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/$RUN_ID" >> $GITHUB_OUTPUT

      - name: Get Policy Checks
        id: policy-checks
        run: |
          RUN_ID="${{ steps.determine-run.outputs.run_id }}"

          echo "ğŸ” Retrieving policy evaluation results using tfci..."
          echo ""

          # Use tfci Docker image to get policy evaluation
          docker run --rm \
            -e TF_API_TOKEN="${{ secrets.TF_API_TOKEN }}" \
            cloudbrokeraz/tfci:latest \
            tfci -organization "${{ env.TF_CLOUD_ORGANIZATION }}" \
            policy show --run "$RUN_ID" --json > policy_output.json

          # Check if tfci command succeeded
          if [ $? -ne 0 ]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace or error retrieving policies"
            exit 0
          fi

          # Parse basic counts from tfci output
          TOTAL=$(jq -r '.total_count // 0' policy_output.json)
          PASSED=$(jq -r '.passed_count // 0' policy_output.json)
          ADVISORY_FAILED=$(jq -r '.advisory_failed_count // 0' policy_output.json)
          MANDATORY_FAILED=$(jq -r '.mandatory_failed_count // 0' policy_output.json)
          ERRORED=$(jq -r '.errored_count // 0' policy_output.json)
          REQUIRES_OVERRIDE=$(jq -r '.requires_override // false' policy_output.json)

          if [ "$TOTAL" -eq 0 ]; then
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No Sentinel policies configured for this workspace"
            exit 0
          fi

          echo "policies_enabled=true" >> $GITHUB_OUTPUT
          echo "policy_count=$TOTAL" >> $GITHUB_OUTPUT
          echo "policies_passed=$PASSED" >> $GITHUB_OUTPUT
          echo "policies_advisory_failed=$ADVISORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT
          echo "policies_errored=$ERRORED" >> $GITHUB_OUTPUT
          echo "requires_override=$REQUIRES_OVERRIDE" >> $GITHUB_OUTPUT

          # Store the complete policy_details as output
          POLICY_DETAILS=$(jq -c '.policy_details // {}' policy_output.json)
          echo "policy_details=$POLICY_DETAILS" >> $GITHUB_OUTPUT

          echo "ğŸ“Š Policy Evaluation Summary:"
          echo "   Total Policies: $TOTAL"
          echo "   âœ… Passed: $PASSED"
          echo "   âš ï¸  Failed (Advisory): $ADVISORY_FAILED"
          echo "   ğŸš« Failed (Mandatory): $MANDATORY_FAILED"
          echo "   âŒ Errored: $ERRORED"
          echo ""

          # Clean up
          rm -f policy_output.json

      - name: Display Policy Details
        if: steps.policy-checks.outputs.policies_enabled == 'true'
        run: |
          echo "ğŸ“‹ Policy Details (Raw TFC API Response):"
          echo ""
          echo '${{ steps.policy-checks.outputs.policy_details }}' | jq '.'
