# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

name: Terraform Cloud API Workflow

# Trigger conditions - when should this workflow run?
on:
  push:
    branches:
      - main
    paths:
      # Only trigger when Terraform files change
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-apply.yml'

  # Allow manual triggering from GitHub UI
  workflow_dispatch:

# Environment variables available to all jobs and steps
env:
  # These reference GitHub secrets/variables you configured in Task 2
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_WORKSPACE: "it-ops-api-automation"
  # Set log level for debugging (OFF, ERROR, INFO, DEBUG)
  TF_LOG: "INFO"

jobs:
  terraform-plan-apply:
    name: "Terraform Plan & Apply"
    runs-on: ubuntu-latest

    # Set permissions for the GITHUB_TOKEN
    permissions:
      contents: read
      pull-requests: write  # Allows posting plan outputs as PR comments (future enhancement)

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Upload configuration to Terraform Cloud
      - name: Upload Configuration
        uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          directory: "."  # Upload from repository root
          # speculative: false (default) - this is a real run, not just a plan-only test

      # Step 3: Create a run (triggers plan)
      - name: Create Run
        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: create-run
        with:
          workspace: ${{ env.TF_WORKSPACE }}
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
          message: |
            Triggered by @${{ github.actor }} via ${{ github.event_name }}

            ${{ github.event.head_commit.message || 'Manual workflow dispatch' }}

            Commit: ${{ github.sha }}
          # plan_only: false (default) - allow this run to be applied
          # is_destroy: false (default) - this is a normal apply, not a destroy

      # Step 4: Get plan output to check if changes exist
      - name: Get Plan Output
        uses: hashicorp/tfc-workflows-github/actions/plan-output@v1.3.2
        id: plan-output
        if: always()
        with:
          plan: ${{ steps.create-run.outputs.plan_id }}

      # Step 4b: Get detailed run information (includes Sentinel policy checks)
      - name: Get Run Details
        uses: hashicorp/tfc-workflows-github/actions/show-run@v1.3.2
        id: run-details
        if: always()
        with:
          run: ${{ steps.create-run.outputs.run_id }}

      # Step 4c: Fetch and display Sentinel policy evaluation results
      - name: Fetch Policy Evaluation Results
        if: always()
        id: policy-checks
        continue-on-error: true
        run: |
          echo "::group::Sentinel Policy Evaluation Results"

          # Step 1: Get task stages for this run
          TASK_STAGES=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ steps.create-run.outputs.run_id }}/task-stages")

          # Find task stages with policy evaluations
          POLICY_STAGE_IDS=$(echo "$TASK_STAGES" | jq -r '.data[] | select(.relationships."policy-evaluations".data != null and (.relationships."policy-evaluations".data | length) > 0) | .id')

          if [ -z "$POLICY_STAGE_IDS" ]; then
            echo "â„¹ï¸  No Sentinel policy evaluations configured for this workspace"
            echo "policy_count=0" >> $GITHUB_OUTPUT
            echo "policies_enabled=false" >> $GITHUB_OUTPUT
            echo "::endgroup::"
            exit 0
          fi

          echo "âœ… Sentinel policy evaluations detected"
          echo ""

          # Step 2: For each task stage with policies, get the policy evaluations
          TOTAL_EVALUATIONS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0

          for STAGE_ID in $POLICY_STAGE_IDS; do
            POLICY_EVALS=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/task-stages/$STAGE_ID/policy-evaluations")

            # Parse evaluation results
            echo "$POLICY_EVALS" | jq -r '.data[] | "ðŸ“‹ Policy Evaluation: \(.id)\n   Status: \(.attributes.status)\n   Policy Engine: \(.attributes."policy-kind")\n   Results:\n     â€¢ Passed: \(.attributes."result-count".passed)\n     â€¢ Advisory Failed: \(.attributes."result-count"."advisory-failed")\n     â€¢ Mandatory Failed: \(.attributes."result-count"."mandatory-failed")\n     â€¢ Errored: \(.attributes."result-count".errored)\n"'

            # Aggregate counts
            EVAL_COUNT=$(echo "$POLICY_EVALS" | jq -r '.data | length')
            PASSED=$(echo "$POLICY_EVALS" | jq -r '[.data[].attributes."result-count".passed] | add // 0')
            ADV_FAILED=$(echo "$POLICY_EVALS" | jq -r '[.data[].attributes."result-count"."advisory-failed"] | add // 0')
            MAND_FAILED=$(echo "$POLICY_EVALS" | jq -r '[.data[].attributes."result-count"."mandatory-failed"] | add // 0')

            TOTAL_EVALUATIONS=$((TOTAL_EVALUATIONS + EVAL_COUNT))
            TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
            TOTAL_FAILED=$((TOTAL_FAILED + ADV_FAILED + MAND_FAILED))
          done

          echo ""
          echo "ðŸ“Š Summary:"
          echo "   Total Policy Evaluations: $TOTAL_EVALUATIONS"
          echo "   Total Policies Passed: $TOTAL_PASSED"
          echo "   Total Policies Failed: $TOTAL_FAILED"
          echo ""
          echo "â„¹ï¸  Detailed policy results available in Terraform Cloud"
          echo "   View at: ${{ steps.create-run.outputs.run_link }}"

          # Save for summary
          echo "policy_count=$TOTAL_EVALUATIONS" >> $GITHUB_OUTPUT
          echo "policies_enabled=true" >> $GITHUB_OUTPUT
          echo "policies_passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
          echo "policies_failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      # Step 5: Apply the run (only if there are changes)
      - name: Apply Run
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
        id: apply
        if: steps.plan-output.outputs.add != '0' || steps.plan-output.outputs.change != '0' || steps.plan-output.outputs.destroy != '0'
        with:
          run: ${{ steps.create-run.outputs.run_id }}
          comment: |
            Auto-applied by @${{ github.actor }} via GitHub Actions (Run #${{ github.run_number }})

            Commit: ${{ github.event.head_commit.message || 'Manual workflow dispatch' }}

      # Step 5b: Skip message when no changes
      - name: No Changes Detected
        if: steps.plan-output.outputs.add == '0' && steps.plan-output.outputs.change == '0' && steps.plan-output.outputs.destroy == '0'
        run: |
          echo "::notice::No infrastructure changes detected. Skipping apply step."
          echo "Plan showed 0 resources to add, change, or destroy."

      # Step 6: Create workflow summary
      - name: Create Workflow Summary
        if: always()
        run: |
          echo "# ðŸš€ Terraform Cloud API Workflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status badge at the top
          if [ "${{ steps.apply.outputs.status }}" == "Success" ]; then
            echo "## âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.apply.conclusion }}" == "skipped" ]; then
            echo "## âœ¨ No Changes Required" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.apply.outputs.status }}" == "Error" ]; then
            echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Deployment Status: ${{ steps.apply.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Workflow metadata
          echo "### ðŸ“‹ Run Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Organization** | \`${{ env.TF_CLOUD_ORGANIZATION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Terraform Cloud run info
          echo "### â˜ï¸ Terraform Cloud Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ steps.create-run.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Plan ID** | \`${{ steps.create-run.outputs.plan_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Configuration Version** | \`${{ steps.upload.outputs.configuration_version_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Plan Status** | \`${{ steps.create-run.outputs.plan_status }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.apply.conclusion }}" == "skipped" ]; then
            echo "| **Apply Status** | \`Skipped (no changes)\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Apply Status** | \`${{ steps.apply.outputs.status }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Plan changes summary
          echo "### ðŸ“Š Infrastructure Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Change Type | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| âž• Resources to Add | ${{ steps.plan-output.outputs.add }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Resources to Change | ${{ steps.plan-output.outputs.change }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âž– Resources to Destroy | ${{ steps.plan-output.outputs.destroy }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Sentinel policy evaluation section
          if [ "${{ steps.policy-checks.outputs.policies_enabled }}" == "true" ]; then
            echo "### ðŸ›¡ï¸ Sentinel Policy Evaluations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Policies Passed** | ${{ steps.policy-checks.outputs.policies_passed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ **Policies Failed (Advisory)** | ${{ steps.policy-checks.outputs.policies_failed }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“‹ **Total Evaluations** | ${{ steps.policy-checks.outputs.policy_count }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”§ **Enforcement Mode** | Advisory (warnings only) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ **Policy Governance**: Sentinel policies validate configuration compliance even when no infrastructure changes are detected. View detailed policy results in the Terraform Cloud run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Links section
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ [View Run in Terraform Cloud](${{ steps.create-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š [Workspace Overview](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ [Workspace Variables](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/variables)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ [Policy Sets](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/settings/policy-sets)" >> $GITHUB_STEP_SUMMARY
          echo "- âš™ï¸ [Workspace Settings](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/settings/general)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Conditional success/failure message
          if [ "${{ steps.apply.outputs.status }}" == "Success" ]; then
            echo "### ðŸŽ‰ What Happened?" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your infrastructure changes have been successfully applied! The Terraform configuration was:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ“¤ **Uploaded** to Terraform Cloud as configuration version \`${{ steps.upload.outputs.configuration_version_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“‹ **Planned** by Terraform Cloud (run \`${{ steps.create-run.outputs.run_id }}\`)" >> $GITHUB_STEP_SUMMARY
            echo "3. âœ… **Applied** successfully with all changes committed to your infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ **API-Driven Workflow**: This deployment used Terraform Cloud's API, not the CLI. All execution happened in TFC's secure environment." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.apply.conclusion }}" == "skipped" ]; then
            echo "### âœ¨ What Happened?" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your infrastructure is already up to date! The Terraform configuration was:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. ðŸ“¤ **Uploaded** to Terraform Cloud as configuration version \`${{ steps.upload.outputs.configuration_version_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ“‹ **Planned** by Terraform Cloud (run \`${{ steps.create-run.outputs.run_id }}\`)" >> $GITHUB_STEP_SUMMARY
            echo "3. â­ï¸ **Apply skipped** - plan showed 0 resources to add, change, or destroy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> ðŸ’¡ **Infrastructure Drift Check**: No changes were needed, confirming your infrastructure matches your codeâ€”a valuable validation!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The apply step encountered an issue. Please review the following:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the [run details in Terraform Cloud](${{ steps.create-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
            echo "2. Review the plan output above for any errors" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify workspace variables and provider credentials" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: \`${{ steps.apply.outputs.status }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}) using [tfc-workflows-github](https://github.com/hashicorp/tfc-workflows-github)*" >> $GITHUB_STEP_SUMMARY

      # Step 7: Handle failures
      - name: Check Apply Status
        if: steps.apply.conclusion == 'failure'
        run: |
          echo "::error::Terraform apply failed with status: ${{ steps.apply.outputs.status }}"
          exit 1
