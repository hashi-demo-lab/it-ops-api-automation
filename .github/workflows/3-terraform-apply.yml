name: "3. Terraform Apply"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to apply'
        required: true
        type: string
      comment:
        description: 'Optional comment for the apply'
        required: false
        type: string
        default: 'Applied from GitHub Actions'
  # workflow_run:
  #   workflows: ["2. Sentinel Policy Check"]
  #   types:
  #     - completed

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}

jobs:
  terraform-apply:
    name: "Apply Terraform Changes"
    runs-on: ubuntu-latest

    outputs:
      apply_status: ${{ steps.apply.outputs.status }}
      run_status: ${{ steps.apply.outputs.run_status }}

    steps:
      - name: Determine Run ID
        id: determine-run
        run: |
          if [ -n "${{ github.event.inputs.run_id }}" ]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
            echo "ðŸ“ Using manually provided run ID: $RUN_ID"
          else
            # Get the run ID from the Policy Check workflow
            # This would need to be passed via artifact or API call
            echo "::error::No run ID provided. Please provide run_id input."
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/$RUN_ID" >> $GITHUB_OUTPUT

      - name: Verify Run is Ready for Apply
        id: verify-run
        run: |
          echo "ðŸ” Verifying run is ready for apply..."
          echo ""

          RUN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ steps.determine-run.outputs.run_id }}")

          CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
          echo "Current run status: $CURRENT_STATUS"
          echo ""

          # Check if run is in a state that allows apply
          case $CURRENT_STATUS in
            apply_queued|post_plan_completed|planned|policy_override)
              echo "âœ… Run is ready for apply (status: $CURRENT_STATUS)"
              echo "is_ready=true" >> $GITHUB_OUTPUT
              ;;

            applied)
              echo "::warning::âš ï¸  Run has already been applied"
              echo ""
              echo "The infrastructure changes were already applied, likely:"
              echo "  - Manually triggered in TFC UI"
              echo "  - Auto-applied after policy override (if workspace has auto-apply enabled)"
              echo "  - Applied by a previous workflow run"
              echo ""
              echo "No further action needed - skipping apply step."
              echo "is_ready=false" >> $GITHUB_OUTPUT
              echo "already_applied=true" >> $GITHUB_OUTPUT
              ;;

            post_plan_awaiting_decision)
              echo "::error::âŒ Run is still waiting for policy override"
              echo "::error::"
              echo "::error::The run cannot be applied yet because:"
              echo "::error::  - Soft-mandatory Sentinel policies failed"
              echo "::error::  - Override has not been completed in TFC"
              echo "::error::"
              echo "::error::Next steps:"
              echo "::error::  1. Go to TFC: ${{ steps.determine-run.outputs.run_link }}"
              echo "::error::  2. Review the failed policies"
              echo "::error::  3. Click 'Override & Continue' if appropriate"
              echo "::error::  4. Wait for Workflow 2 (Policy Check) to detect the override"
              echo "::error::  5. Then re-run this Apply workflow"
              echo "is_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;

            discarded)
              echo "::error::âŒ Run was discarded - cannot apply"
              echo "::error::"
              echo "::error::This run was intentionally discarded, meaning:"
              echo "::error::  - A user chose not to proceed with these changes"
              echo "::error::  - The infrastructure changes will not be applied"
              echo "::error::"
              echo "::error::If you want to apply these changes:"
              echo "::error::  - Create a new plan with Workflow 1"
              echo "is_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;

            canceled|force_canceled)
              echo "::error::âŒ Run was canceled - cannot apply"
              echo "::error::"
              echo "::error::This run was canceled and cannot be resumed."
              echo "::error::"
              echo "::error::If you want to apply these changes:"
              echo "::error::  - Create a new plan with Workflow 1"
              echo "is_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;

            errored)
              echo "::error::âŒ Run encountered an error"
              echo "::error::"
              echo "::error::The run failed during execution."
              echo "::error::View error details: ${{ steps.determine-run.outputs.run_link }}"
              echo "is_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;

            *)
              echo "::error::âŒ Run is not in a state that allows apply"
              echo "::error::"
              echo "::error::Current status: $CURRENT_STATUS"
              echo "::error::"
              echo "::error::Expected statuses for apply:"
              echo "::error::  - apply_queued (ready to apply)"
              echo "::error::  - post_plan_completed (plan finished, override complete)"
              echo "::error::  - planned (plan complete)"
              echo "::error::  - policy_override (override applied)"
              echo "::error::"
              echo "::error::View run details: ${{ steps.determine-run.outputs.run_link }}"
              echo "is_ready=false" >> $GITHUB_OUTPUT
              exit 1
              ;;
          esac

      - name: Check if Changes Exist
        id: check-changes
        run: |
          RUN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ steps.determine-run.outputs.run_id }}")

          PLAN_ID=$(echo "$RUN_DATA" | jq -r '.data.relationships.plan.data.id')

          if [[ -z "$PLAN_ID" || "$PLAN_ID" == "null" ]]; then
            echo "::error::No plan ID found for this run"
            exit 1
          fi

          # Get plan details
          PLAN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/plans/$PLAN_ID")

          ADD=$(echo "$PLAN_DATA" | jq -r '.data.attributes."resource-additions" // 0')
          CHANGE=$(echo "$PLAN_DATA" | jq -r '.data.attributes."resource-changes" // 0')
          DESTROY=$(echo "$PLAN_DATA" | jq -r '.data.attributes."resource-destructions" // 0')

          echo "add=$ADD" >> $GITHUB_OUTPUT
          echo "change=$CHANGE" >> $GITHUB_OUTPUT
          echo "destroy=$DESTROY" >> $GITHUB_OUTPUT

          TOTAL=$((ADD + CHANGE + DESTROY))
          echo "total_changes=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -eq 0 ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::â„¹ï¸  No infrastructure changes to apply"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Changes to apply: +$ADD ~$CHANGE -$DESTROY"
          fi

      - name: Apply Run
        id: apply
        if: |
          steps.verify-run.outputs.is_ready == 'true' &&
          steps.verify-run.outputs.already_applied != 'true' &&
          steps.check-changes.outputs.has_changes == 'true'
        uses: hashicorp/tfc-workflows-github/actions/apply-run@v1.3.2
        with:
          run: ${{ steps.determine-run.outputs.run_id }}
          comment: ${{ github.event.inputs.comment || 'Applied from GitHub Actions - Apply workflow' }}

      - name: Skip Apply (No Changes)
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "::notice::No infrastructure changes detected - skipping apply"
          echo "This is expected when there are no resources to add, change, or destroy."

      - name: Skip Apply (Already Applied)
        if: steps.verify-run.outputs.already_applied == 'true'
        run: |
          echo "::notice::Run has already been applied"
          echo "This typically means the apply was triggered manually in TFC or by another process."

      - name: Wait for Apply Completion
        id: wait-apply
        if: steps.apply.conclusion == 'success'
        timeout-minutes: 30
        run: |
          echo "â³ Waiting for apply to complete..."
          echo "Run ID: ${{ steps.determine-run.outputs.run_id }}"
          echo "View in TFC: ${{ steps.determine-run.outputs.run_link }}"
          echo ""

          MAX_WAIT=1800  # 30 minutes
          ELAPSED=0
          CHECK_INTERVAL=15

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RUN_DATA=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/runs/${{ steps.determine-run.outputs.run_id }}")

            CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')

            # Calculate minutes elapsed
            MINUTES=$((ELAPSED / 60))
            SECONDS=$((ELAPSED % 60))
            echo "[$(date +%H:%M:%S)] Status: $CURRENT_STATUS (elapsed: ${MINUTES}m ${SECONDS}s)"

            case $CURRENT_STATUS in
              applied)
                echo ""
                echo "âœ… Apply completed successfully!"
                echo "apply_completed=true" >> $GITHUB_OUTPUT
                echo "final_status=applied" >> $GITHUB_OUTPUT
                exit 0
                ;;
              errored)
                echo "::error::âŒ Apply failed with errors"
                echo "apply_completed=false" >> $GITHUB_OUTPUT
                echo "final_status=errored" >> $GITHUB_OUTPUT
                exit 1
                ;;
              canceled|force_canceled)
                echo "::error::â›” Apply was canceled"
                echo "apply_completed=false" >> $GITHUB_OUTPUT
                echo "final_status=canceled" >> $GITHUB_OUTPUT
                exit 1
                ;;
              applying)
                # Still applying - continue waiting
                ;;
              *)
                echo "::warning::Unexpected status during apply: $CURRENT_STATUS"
                ;;
            esac

            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done

          echo "::error::â±ï¸  Timeout: Apply did not complete within 30 minutes"
          exit 1

      - name: Get Final Run Details
        id: final-details
        if: always()
        run: |
          RUN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ steps.determine-run.outputs.run_id }}")

          FINAL_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
          echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT

      - name: Generate Summary
        if: always()
        run: |
          echo "# âœ… Terraform Apply Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Apply Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 3. Terraform Apply |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ steps.determine-run.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY

          # Determine apply status
          if [ "${{ steps.verify-run.outputs.already_applied }}" == "true" ]; then
            echo "| **Status** | \`Already Applied\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-changes.outputs.has_changes }}" == "false" ]; then
            echo "| **Status** | \`Skipped (no changes)\` |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.wait-apply.outputs.apply_completed }}" == "true" ]; then
            echo "| **Status** | \`Applied Successfully\` âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.apply.conclusion }}" == "success" ]; then
            echo "| **Status** | \`${{ steps.final-details.outputs.final_status }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | \`${{ steps.final-details.outputs.final_status }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Changes applied
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "### ðŸ“Š Infrastructure Changes Applied" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Change Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âž• Resources Added | ${{ steps.check-changes.outputs.add }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”„ Resources Changed | ${{ steps.check-changes.outputs.change }} |" >> $GITHUB_STEP_SUMMARY
            echo "| âž– Resources Destroyed | ${{ steps.check-changes.outputs.destroy }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Completion message
          echo "### ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.wait-apply.outputs.apply_completed }}" == "true" ]; then
            echo "Infrastructure changes have been successfully applied to your environment." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check-changes.outputs.has_changes }}" == "false" ]; then
            echo "No infrastructure changes were required." >> $GITHUB_STEP_SUMMARY
          else
            echo "Check the run details for the current status." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.determine-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Terraform Apply*" >> $GITHUB_STEP_SUMMARY
