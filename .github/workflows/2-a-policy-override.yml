name: "2a. Policy Override"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to override'
        required: true
        type: string
      justification:
        description: 'Justification for overriding the policy (required for audit trail)'
        required: true
        type: string

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}

jobs:
  policy-override:
    name: "Override Mandatory Policy Failures"
    runs-on: ubuntu-latest

    outputs:
      override_complete: ${{ steps.override.outputs.override_complete }}
      final_status: ${{ steps.override.outputs.final_status }}

    steps:
      - name: Verify Run Status
        id: verify-run
        run: |
          echo "ðŸ” Verifying run is in correct state for override..."
          echo ""

          RUN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ env.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ github.event.inputs.run_id }}")

          CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
          echo "Current run status: $CURRENT_STATUS"
          echo ""

          # Verify run is awaiting override
          if [[ "$CURRENT_STATUS" != "post_plan_awaiting_decision" ]]; then
            echo "::error::âŒ Run is not in the correct state for override"
            echo "::error::"
            echo "::error::Current status: $CURRENT_STATUS"
            echo "::error::Expected status: post_plan_awaiting_decision"
            echo "::error::"

            case $CURRENT_STATUS in
              planned|policy_override|post_plan_completed|apply_queued)
                echo "::error::This run has already been overridden or doesn't need override."
                echo "::error::Proceed to the Apply workflow (Workflow 3)."
                ;;
              applied)
                echo "::error::This run has already been applied."
                ;;
              discarded)
                echo "::error::This run was discarded and cannot be overridden."
                ;;
              *)
                echo "::error::Cannot override a run in status: $CURRENT_STATUS"
                ;;
            esac
            exit 1
          fi

          echo "âœ… Run is awaiting policy override decision"
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/${{ github.event.inputs.run_id }}" >> $GITHUB_OUTPUT

      - name: Apply Policy Override
        id: override
        run: |
          echo "ðŸ›¡ï¸ Applying policy override using tfci..."
          echo ""
          echo "Run ID: ${{ github.event.inputs.run_id }}"
          echo "Justification: ${{ github.event.inputs.justification }}"
          echo ""

          # Use tfci Docker image to apply policy override
          docker run --rm \
            -e TF_API_TOKEN="${{ env.TF_API_TOKEN }}" \
            cloudbrokeraz/tfci:latest \
            tfci -organization "${{ env.TF_CLOUD_ORGANIZATION }}" \
            policy override \
            --run "${{ github.event.inputs.run_id }}" \
            --justification "${{ github.event.inputs.justification }}" \
            --json > override_output.json

          # Check if tfci command succeeded
          if [ $? -eq 0 ]; then
            echo "override_complete=true" >> $GITHUB_OUTPUT

            # Parse output
            FINAL_STATUS=$(jq -r '.final_status // "unknown"' override_output.json)
            OVERRIDE_STATUS=$(jq -r '.override_complete // false' override_output.json)
            MANDATORY_FAILED=$(jq -r '.mandatory_failed_count // 0' override_output.json)

            echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT
            echo "ready_for_apply=true" >> $GITHUB_OUTPUT
            echo "mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT

            # Extract failed policies for summary
            FAILED_POLICIES=$(jq -r '
              .failed_policies // [] |
              if length > 0 then
                map("- \(.policy_name)") | join("\n")
              else
                "No specific policy names available"
              end
            ' override_output.json)

            {
              echo "failed_policies<<EOF"
              echo "$FAILED_POLICIES"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            echo ""
            echo "âœ… Policy override completed successfully"
            echo "Final run status: $FINAL_STATUS"
          else
            echo "override_complete=false" >> $GITHUB_OUTPUT
            echo "::error::âŒ Failed to apply policy override"
            cat override_output.json 2>/dev/null || echo "No output available"
            rm -f override_output.json
            exit 1
          fi

          # Clean up
          rm -f override_output.json

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Policy Override Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Override Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 2a. Policy Override |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ github.event.inputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.override.outputs.override_complete }}" == "true" ]; then
            echo "| **Status** | âœ… Override Applied |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | âŒ Override Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Failed policies
          if [ -n "${{ steps.override.outputs.failed_policies }}" ]; then
            echo "### ðŸš« Overridden Policies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following mandatory policies were overridden:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.override.outputs.failed_policies }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Justification
          echo "### ðŸ“ Justification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ${{ github.event.inputs.justification }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Audit Trail**: This override decision is recorded in Terraform Cloud for compliance review." >> $GITHUB_STEP_SUMMARY
          echo "> All policy overrides are logged with timestamp, user, and justification." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Next steps
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.override.outputs.override_complete }}" == "true" ]; then
            echo "**Override Successful - Ready to Apply:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Run the \`3. Terraform Apply\` workflow to apply infrastructure changes" >> $GITHUB_STEP_SUMMARY
            echo "- The run is now in status: \`${{ steps.override.outputs.final_status }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Override Failed:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Check the error messages above" >> $GITHUB_STEP_SUMMARY
            echo "- Verify the run is in the correct state" >> $GITHUB_STEP_SUMMARY
            echo "- Check token permissions (requires write access)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.verify-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Policy Override | Overridden by: ${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY
