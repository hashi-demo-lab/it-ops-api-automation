name: "2a. Policy Override"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to override'
        required: true
        type: string
      justification:
        description: 'Justification for overriding the policy (required for audit trail)'
        required: true
        type: string

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}

jobs:
  policy-override:
    name: "Override Mandatory Policy Failures"
    runs-on: ubuntu-latest

    outputs:
      override_complete: ${{ steps.override.outputs.override_complete }}
      final_status: ${{ steps.wait-override.outputs.final_status }}

    steps:
      - name: Verify Run Status
        id: verify-run
        run: |
          echo "ðŸ” Verifying run is in correct state for override..."
          echo ""

          RUN_DATA=$(curl -s \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            "https://app.terraform.io/api/v2/runs/${{ github.event.inputs.run_id }}")

          CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
          echo "Current run status: $CURRENT_STATUS"
          echo ""

          # Verify run is awaiting override
          if [[ "$CURRENT_STATUS" != "post_plan_awaiting_decision" ]]; then
            echo "::error::âŒ Run is not in the correct state for override"
            echo "::error::"
            echo "::error::Current status: $CURRENT_STATUS"
            echo "::error::Expected status: post_plan_awaiting_decision"
            echo "::error::"

            case $CURRENT_STATUS in
              planned|policy_override|post_plan_completed|apply_queued)
                echo "::error::This run has already been overridden or doesn't need override."
                echo "::error::Proceed to the Apply workflow (Workflow 3)."
                ;;
              applied)
                echo "::error::This run has already been applied."
                ;;
              discarded)
                echo "::error::This run was discarded and cannot be overridden."
                ;;
              *)
                echo "::error::Cannot override a run in status: $CURRENT_STATUS"
                ;;
            esac
            exit 1
          fi

          echo "âœ… Run is awaiting policy override decision"
          echo "run_link=https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/${{ github.event.inputs.run_id }}" >> $GITHUB_OUTPUT

      - name: Get Failed Policies
        id: get-policies
        run: |
          echo "ðŸ“‹ Retrieving failed mandatory policies..."
          echo ""

          # Function: Call TFC API
          tfc_api_call() {
            local endpoint=$1
            curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2${endpoint}"
          }

          # Get task stages for this run
          TASK_STAGES=$(tfc_api_call "/runs/${{ github.event.inputs.run_id }}/task-stages")

          # Get policy stage ID
          POLICY_STAGE_ID=$(echo "$TASK_STAGES" | jq -r '.data[] | select(.attributes.stage == "post_plan") | .id' | head -n1)

          if [[ -z "$POLICY_STAGE_ID" || "$POLICY_STAGE_ID" == "null" ]]; then
            echo "::error::No policy evaluations found for this run"
            exit 1
          fi

          # Get policy evaluations
          POLICY_EVALS=$(tfc_api_call "/task-stages/$POLICY_STAGE_ID/policy-evaluations")
          POLICY_EVAL_ID=$(echo "$POLICY_EVALS" | jq -r '.data[0].id')

          # Get mandatory failed count
          MANDATORY_FAILED=$(echo "$POLICY_EVALS" | jq '[.data[].attributes."result-count"."mandatory-failed"] | add // 0')

          echo "Mandatory policy failures: $MANDATORY_FAILED"
          echo "mandatory_failed=$MANDATORY_FAILED" >> $GITHUB_OUTPUT

          if [ "$MANDATORY_FAILED" -eq 0 ]; then
            echo "::error::No mandatory policy failures found - override not needed"
            exit 1
          fi

          # Get individual failed policies from nested outcomes array
          POLICY_SET_OUTCOMES=$(tfc_api_call "/policy-evaluations/$POLICY_EVAL_ID/policy-set-outcomes")

          FAILED_POLICIES=$(echo "$POLICY_SET_OUTCOMES" | jq -r '
            if (.data != null and (.data | length) > 0) then
              [.data[].attributes.outcomes[] |
                select(.status == "failed") |
                select(.enforcement_level == "mandatory") |
                "- \(.policy_name)"
              ] |
              if length > 0 then
                join("\n")
              else
                "No specific policy names available"
              end
            else
              "No specific policy names available"
            end
          ')

          echo ""
          echo "Failed Mandatory Policies:"
          echo "$FAILED_POLICIES"
          echo ""

          {
            echo "failed_policies<<EOF"
            echo "$FAILED_POLICIES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Get Policy Check ID
        id: get-policy-check
        run: |
          echo "ðŸ” Finding policy check to override..."

          # Function: Call TFC API
          tfc_api_call() {
            local endpoint=$1
            curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2${endpoint}"
          }

          # Get run details to find policy check
          RUN_DATA=$(tfc_api_call "/runs/${{ github.event.inputs.run_id }}")

          # Debug: Show what relationships exist
          echo "DEBUG: Available relationships:"
          echo "$RUN_DATA" | jq -c '.data.relationships | keys'
          echo ""

          # Debug: Show the policy-checks relationship
          echo "DEBUG: policy-checks relationship:"
          echo "$RUN_DATA" | jq -c '.data.relationships."policy-checks"'
          echo ""

          # Try policy-checks first (legacy)
          POLICY_CHECK_ID=$(echo "$RUN_DATA" | jq -r '.data.relationships."policy-checks".data[0].id // empty')

          # If no policy-checks, try task-stages (newer policy evaluations)
          if [[ -z "$POLICY_CHECK_ID" || "$POLICY_CHECK_ID" == "null" ]]; then
            echo "No legacy policy-checks found, checking task-stages..."

            # Get task stages
            TASK_STAGES=$(tfc_api_call "/runs/${{ github.event.inputs.run_id }}/task-stages")

            echo "DEBUG: Task stages:"
            echo "$TASK_STAGES" | jq -c '.data[] | {id: .id, stage: .attributes.stage, status: .attributes.status}'
            echo ""

            # Get the post_plan stage which contains policy evaluations
            POLICY_STAGE_DATA=$(echo "$TASK_STAGES" | jq '.data[] | select(.attributes.stage == "post_plan")')
            POLICY_STAGE_ID=$(echo "$POLICY_STAGE_DATA" | jq -r '.id')

            if [[ -n "$POLICY_STAGE_ID" && "$POLICY_STAGE_ID" != "null" ]]; then
              echo "Found policy stage: $POLICY_STAGE_ID"
              echo ""

              # Show full task stage data for debugging
              echo "DEBUG: Full post_plan task stage data:"
              echo "$POLICY_STAGE_DATA" | jq '.'
              echo ""

              # Check the stage status and permissions
              STAGE_STATUS=$(echo "$POLICY_STAGE_DATA" | jq -r '.attributes.status')
              CAN_OVERRIDE=$(echo "$POLICY_STAGE_DATA" | jq -r '.attributes.permissions."can-override" // false')

              echo "ðŸ“Š Task Stage Status: $STAGE_STATUS"
              echo "ðŸ” Can Override: $CAN_OVERRIDE"
              echo ""

              # Check if this stage is actually overridable
              if [[ "$STAGE_STATUS" != "awaiting_override" ]]; then
                echo "::error::âŒ Task stage is not in 'awaiting_override' status"
                echo "::error::"
                echo "::error::Current status: $STAGE_STATUS"
                echo "::error::"
                echo "::error::This stage cannot be overridden because:"

                case $STAGE_STATUS in
                  passed)
                    echo "::error::  - The policies have already passed"
                    echo "::error::  - No override is needed"
                    ;;
                  failed)
                    echo "::error::  - This is a HARD-MANDATORY policy failure"
                    echo "::error::  - Hard-mandatory policies cannot be overridden via API"
                    echo "::error::  - You must fix the code to satisfy the policy"
                    ;;
                  errored)
                    echo "::error::  - The policy evaluation encountered an error"
                    echo "::error::  - Check the policy code or evaluation logs"
                    ;;
                  *)
                    echo "::error::  - Unknown status: $STAGE_STATUS"
                    ;;
                esac

                echo "::error::"
                echo "::error::Expected status: awaiting_override (for soft-mandatory failures)"
                exit 1
              fi

              if [[ "$CAN_OVERRIDE" != "true" ]]; then
                echo "::error::âŒ Token does not have permission to override this stage"
                echo "::error::"
                echo "::error::The TF_API_TOKEN secret does not have 'can-override' permission."
                echo "::error::Verify the token has appropriate permissions in TFC."
                exit 1
              fi

              echo "policy_stage_id=$POLICY_STAGE_ID" >> $GITHUB_OUTPUT
              echo "stage_status=$STAGE_STATUS" >> $GITHUB_OUTPUT
              echo "using_policy_evaluations=true" >> $GITHUB_OUTPUT
            else
              echo "::error::No policy checks or evaluations found for this run"
              exit 1
            fi
          else
            echo "Policy Check ID: $POLICY_CHECK_ID"
            echo "policy_check_id=$POLICY_CHECK_ID" >> $GITHUB_OUTPUT
            echo "using_policy_evaluations=false" >> $GITHUB_OUTPUT
          fi

      - name: Apply Override
        id: override
        run: |
          echo "ðŸ›¡ï¸ Applying policy override via API..."
          echo ""
          echo "Justification: ${{ github.event.inputs.justification }}"
          echo ""

          # Determine which override endpoint to use
          if [[ "${{ steps.get-policy-check.outputs.using_policy_evaluations }}" == "true" ]]; then
            # Use task-stage override (newer policy evaluations)
            echo "Using task-stage override endpoint..."
            OVERRIDE_URL="https://app.terraform.io/api/v2/task-stages/${{ steps.get-policy-check.outputs.policy_stage_id }}/actions/override"
          else
            # Use policy-check override (legacy)
            echo "Using policy-check override endpoint..."
            OVERRIDE_URL="https://app.terraform.io/api/v2/policy-checks/${{ steps.get-policy-check.outputs.policy_check_id }}/actions/override"
          fi

          echo "Override URL: $OVERRIDE_URL"

          # Apply override
          OVERRIDE_RESPONSE=$(curl -s -w "\n%{http_code}" \
            --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
            --header "Content-Type: application/vnd.api+json" \
            --request POST \
            "$OVERRIDE_URL")

          # Extract HTTP status code and body
          HTTP_CODE=$(echo "$OVERRIDE_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$OVERRIDE_RESPONSE" | sed '$d')

          echo "Response status: $HTTP_CODE"

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "âœ… Policy override applied successfully"
            echo "override_complete=true" >> $GITHUB_OUTPUT

            # Now add the justification comment to the run
            echo ""
            echo "ðŸ“ Adding justification comment..."

            COMMENT_RESPONSE=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              --request POST \
              --data "{\"data\":{\"type\":\"comments\",\"attributes\":{\"body\":\"Policy Override Justification: ${{ github.event.inputs.justification }}\"}}}" \
              "https://app.terraform.io/api/v2/runs/${{ github.event.inputs.run_id }}/comments")

            echo "âœ… Justification comment added"
          else
            echo "::error::âŒ Failed to apply override"
            echo "::error::HTTP Status: $HTTP_CODE"
            echo "::error::Response: $RESPONSE_BODY"
            exit 1
          fi

      - name: Wait for Override Completion
        id: wait-override
        timeout-minutes: 5
        run: |
          echo "â³ Waiting for override to complete..."
          echo ""

          MAX_WAIT=300  # 5 minutes
          ELAPSED=0
          CHECK_INTERVAL=10

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RUN_DATA=$(curl -s \
              --header "Authorization: Bearer ${{ secrets.TF_API_TOKEN }}" \
              --header "Content-Type: application/vnd.api+json" \
              "https://app.terraform.io/api/v2/runs/${{ github.event.inputs.run_id }}")

            CURRENT_STATUS=$(echo "$RUN_DATA" | jq -r '.data.attributes.status')
            echo "[$(date +%H:%M:%S)] Current status: $CURRENT_STATUS"

            case $CURRENT_STATUS in
              policy_override|post_plan_completed|apply_queued)
                echo ""
                echo "âœ… Override complete! Run status: $CURRENT_STATUS"
                echo "final_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
                echo "ready_for_apply=true" >> $GITHUB_OUTPUT
                exit 0
                ;;
              errored)
                echo "::error::âŒ Run entered error state after override"
                echo "final_status=errored" >> $GITHUB_OUTPUT
                exit 1
                ;;
            esac

            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done

          echo "::warning::Override applied but status not yet updated (may take a moment)"
          echo "final_status=override_pending" >> $GITHUB_OUTPUT

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ›¡ï¸ Policy Override Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Status section
          echo "### ðŸŽ¯ Override Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Attribute | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow** | 2a. Policy Override |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | \`${{ github.event.inputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workspace** | \`${{ env.TF_WORKSPACE }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.override.outputs.override_complete }}" == "true" ]; then
            echo "| **Status** | âœ… Override Applied |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | âŒ Override Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Failed policies
          if [ -n "${{ steps.get-policies.outputs.failed_policies }}" ]; then
            echo "### ðŸš« Overridden Policies" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following mandatory policies were overridden:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.get-policies.outputs.failed_policies }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Justification
          echo "### ðŸ“ Justification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ${{ github.event.inputs.justification }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Audit Trail**: This override decision is recorded in Terraform Cloud for compliance review." >> $GITHUB_STEP_SUMMARY
          echo "> All policy overrides are logged with timestamp, user, and justification." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Next steps
          echo "### â­ï¸ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.override.outputs.override_complete }}" == "true" ]; then
            echo "**Override Successful - Ready to Apply:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Run the \`3. Terraform Apply\` workflow to apply infrastructure changes" >> $GITHUB_STEP_SUMMARY
            echo "- The run is now in status: \`${{ steps.wait-override.outputs.final_status }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Override Failed:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Check the error messages above" >> $GITHUB_STEP_SUMMARY
            echo "- Verify the run is in the correct state" >> $GITHUB_STEP_SUMMARY
            echo "- Check token permissions (requires write access)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Links
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Run in TFC](${{ steps.verify-run.outputs.run_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Workspace: ${{ env.TF_WORKSPACE }}](https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Metadata
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions | Workflow: Policy Override | Overridden by: ${{ github.actor }}*" >> $GITHUB_STEP_SUMMARY
