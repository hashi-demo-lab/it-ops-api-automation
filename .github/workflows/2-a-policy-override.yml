name: "2a. Policy Override"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'TFC Run ID to override'
        required: true
        type: string
      justification:
        description: 'Justification for override (audit trail)'
        required: true
        type: string

env:
  TF_CLOUD_ORGANIZATION: ${{ vars.TF_CLOUD_ORGANIZATION }}
  TF_API_TOKEN: ${{ secrets.TF_API_APPROVAL_TOKEN }}
  TF_WORKSPACE: ${{ vars.TF_WORKSPACE }}

jobs:
  override:
    name: "Apply Policy Override"
    runs-on: ubuntu-latest

    steps:
      - name: Override Policy
        id: override
        run: |
          docker run --rm \
            -e TF_API_TOKEN="${{ env.TF_API_TOKEN }}" \
            cloudbrokeraz/tfci:latest \
            tfci -organization "${{ env.TF_CLOUD_ORGANIZATION }}" \
            policy override \
            --run "${{ github.event.inputs.run_id }}" \
            --justification "${{ github.event.inputs.justification }}" \
            --json > override.json

          # Extract key details
          FINAL_STATUS=$(jq -r '.final_status // "unknown"' override.json)
          OVERRIDE_COMPLETE=$(jq -r '.override_complete // "false"' override.json)

          echo "final_status=$FINAL_STATUS" >> $GITHUB_OUTPUT
          echo "override_complete=$OVERRIDE_COMPLETE" >> $GITHUB_OUTPUT

          cat override.json
          rm -f override.json

      - name: Generate Summary
        if: always()
        run: |
          RUN_LINK="https://app.terraform.io/app/${{ env.TF_CLOUD_ORGANIZATION }}/workspaces/${{ env.TF_WORKSPACE }}/runs/${{ github.event.inputs.run_id }}"

          echo "# ðŸ›¡ï¸ Policy Override" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`${{ github.event.inputs.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workspace:** \`${{ env.TF_WORKSPACE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.override.outputs.override_complete }}" == "true" ]; then
            echo "## âœ… Override Applied Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Final Status:** \`${{ steps.override.outputs.final_status }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Justification" >> $GITHUB_STEP_SUMMARY
            echo "> ${{ github.event.inputs.justification }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### â­ï¸ Next Step" >> $GITHUB_STEP_SUMMARY
            echo "Run the **3. Terraform Apply** workflow to deploy changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Override Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the error details above and verify:" >> $GITHUB_STEP_SUMMARY
            echo "- Run is in correct state (post_plan_awaiting_decision)" >> $GITHUB_STEP_SUMMARY
            echo "- Token has write permissions" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "[View Run in TFC]($RUN_LINK) | Overridden by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
